<div id="ga-widget" style="display:none;" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white border rounded shadow p-3 w-72 md:w-96 z-50">
  <div class="flex justify-between items-center mb-2">
    <strong>Game Accounts</strong>
    <button id="ga-widget-close" class="text-sm">âœ•</button>
  </div>
  
  <div id="ga-widget-options" class="space-y-2">
    <button id="ga-option-list" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded">
      <strong>List Accounts</strong>
      <div class="text-sm text-gray-600">Select from your game accounts</div>
    </button>
    <button id="ga-option-manage" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded">
      <strong>Manage Accounts</strong>
      <div class="text-sm text-gray-600">View, add, edit, delete accounts</div>
    </button>
  </div>
  
  <div id="ga-widget-list" class="space-y-1" style="display:none;">
    <!-- items inserted here -->
  </div>
</div>

<script>
(function(){
  let currentGameId = null;

  async function fetchAccounts(gameId) {
    const url = new URL('/game-accounts/select_widget/', window.location.origin);
    if (gameId) url.searchParams.set('game', gameId);
    const res = await fetch(url, {credentials: 'same-origin'});
    if (!res.ok) return [];
    return await res.json();
  }

  // toast portal helper
  function getToastPortal(){
    let portal = document.getElementById('tp-toast-portal');
    if (!portal) {
      portal = document.createElement('div');
      portal.id = 'tp-toast-portal';
      portal.style.position = 'fixed';
      portal.style.top = '0';
      portal.style.left = '0';
      portal.style.right = '0';
      portal.style.bottom = '0';
      portal.style.zIndex = '99999999999';
      portal.style.pointerEvents = 'none';
      document.body.appendChild(portal);
    }
    return portal;
  }

  function showToast(msg, isError){
    const portal = getToastPortal();
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.pointerEvents = 'auto';
    t.style.position = 'fixed';
    t.style.top = '2.5rem';
    t.style.right = '1.5rem';
    t.style.padding = '0.5rem 1rem';
    t.style.borderRadius = '0.5rem';
    t.style.color = 'white';
    t.style.backgroundColor = isError ? '#ef4444' : '#16a34a';
    t.style.opacity = '0';
    t.style.transition = 'opacity 120ms ease-in-out';
    t.style.zIndex = '99999999999';
    portal.appendChild(t);
    requestAnimationFrame(()=> t.style.opacity = '1');
    setTimeout(()=> { t.style.opacity = '0'; setTimeout(()=> t.remove(), 140); }, 3000);
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function showList(items) {
    document.getElementById('ga-widget-options').style.display = 'none';
    document.getElementById('ga-widget-list').style.display = 'block';
    
    const container = document.getElementById('ga-widget-list');
    container.innerHTML = '';
    
    if (!items || items.length === 0) {
      const msg = document.createElement('div');
      msg.className = 'text-sm text-gray-600';
      msg.textContent = 'No game accounts found.';
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'mt-2 w-full px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-xl';
      addBtn.textContent = 'Add account';
      addBtn.addEventListener('click', async () => {
        // Open the add-account form as an AJAX modal
        try {
          let modal = document.getElementById('ga-ajax-modal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'ga-ajax-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
            modal.innerHTML = '<div id="ga-ajax-modal-body" class="bg-white rounded p-4 w-96"></div>';
            document.body.appendChild(modal);
          }
          const body = document.getElementById('ga-ajax-modal-body');
          const res = await fetch('/game-accounts/_form/');
          const html = await res.text();
          body.innerHTML = html;

          const cancel = document.getElementById('ga-cancel');
          if (cancel) {
            cancel.className = 'px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl mr-2';
            cancel.addEventListener('click', () => modal.remove());
          }

          const form = document.getElementById('ga-form');
          const submitBtn = document.getElementById('ga-submit');
          if (submitBtn) submitBtn.className = 'px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-xl';
          if (form) form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
              game: form.game.value,
              ingame_name: form.ingame_name.value
            };
            const r = await fetch('/game-accounts/', {
              method: 'POST',
              credentials: 'same-origin',
              headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
              body: JSON.stringify(data)
            });
            if (r.status === 201) {
              showToast('Account added.');
              modal.remove();
              const items = await fetchAccounts(currentGameId);
              renderList(items);
            } else {
              const j = await r.json().catch(()=>({}));
              showToast('Save failed', true);
              console.error('Save failed', j);
            }
          });
        } catch (err) {
          console.error('Failed to open add-account modal', err);
          window.location.href = '/game-accounts/manage/';
        }
      });
      container.appendChild(msg);
      container.appendChild(addBtn);
      return;
    }

    items.forEach(it => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'w-full text-left px-2 py-1 hover:bg-gray-100';
      btn.textContent = it.ingame_name;
      btn.dataset.gaId = it.id;
      btn.addEventListener('click', () => {
        const ev = new CustomEvent('gameaccount:selected', {detail: {id: it.id, name: it.ingame_name}});
        window.dispatchEvent(ev);
      });
      container.appendChild(btn);
    });

    // Add back button to return to options
    const backDiv = document.createElement('div');
    backDiv.className = 'pt-2';
    const backBtn = document.createElement('button');
    backBtn.type = 'button';
    backBtn.className = 'mt-2 w-full px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-xl';
    backBtn.textContent = 'Back to Options';
    backBtn.addEventListener('click', () => {
      document.getElementById('ga-widget-options').style.display = 'block';
      document.getElementById('ga-widget-list').style.display = 'none';
    });
    backDiv.appendChild(backBtn);
    container.appendChild(backDiv);
  }

  function renderList(items) {
    showList(items);
  }

  window.showGameAccountWidget = async function(gameId){
    currentGameId = gameId;
    const widget = document.getElementById('ga-widget');
    try {
      if (!widget) { console.warn('ga-widget element not found'); return; }
      widget.style.display = 'block';
      
      // Show options by default
      document.getElementById('ga-widget-options').style.display = 'block';
      document.getElementById('ga-widget-list').style.display = 'none';
    } catch (err) {
      console.error('Error in showGameAccountWidget', err);
      if (widget) widget.style.display = 'block';
    }
  }

  // Event listeners for options
  document.getElementById('ga-option-list').addEventListener('click', async () => {
    const items = await fetchAccounts(currentGameId);
    renderList(items);
  });

  document.getElementById('ga-option-manage').addEventListener('click', () => {
    window.location.href = '/game-accounts/manage/';
  });

  document.getElementById('ga-widget-close').addEventListener('click', () => {
    document.getElementById('ga-widget').style.display = 'none';
  });

  // expose showToast for manual testing in console
  try { window.showToast = showToast; } catch(e){}

})();
</script>