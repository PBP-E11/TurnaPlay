{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="p-6 pt-20">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-8">
    <div>
      <h1 class="text-2xl font-bold">Manage Game Accounts</h1>
    </div>
    <div>
      <button id="ga-add" class="px-3 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700">Add Account</button>
    </div>
  </div>

  <div class="mb-4">
    <label class="block mb-1">Filter by game</label>
    <select id="filter-game" class="border p-2 rounded">
      <option value="">All Games</option>
      {% for game in games %}
      <option value="{{ game.id }}">{{ game.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div id="ga-list" class="space-y-2">
    <!-- rows inserted here -->
  </div>
</div>

<!-- modal overlay for the form -->
<div id="ga-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded p-4 w-96">
    <div id="ga-modal-body"></div>
  </div>
</div>


<script>
(async function(){
  async function fetchList(gameId) {
    const url = new URL('/game-accounts/', window.location.origin);
    if (gameId) url.searchParams.set('game', gameId);
    const res = await fetch(url, {credentials: 'same-origin'});
    return res.ok ? await res.json() : [];
  }

  function renderItem(it){
    const div = document.createElement('div');
    div.className = 'border p-3 rounded flex justify-between items-center bg-white';
    const left = document.createElement('div');
    left.innerHTML = `<strong class="text-lg">${it.ingame_name}</strong><div class="text-sm text-gray-600 mt-1">Game: ${it.game_name}</div>`;
    const right = document.createElement('div');
    const del = document.createElement('button');
    del.className = 'px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600';
    del.textContent = 'Delete';
        del.addEventListener('click', async ()=>{
      if (!confirm('Delete this game account? This action cannot be undone.')) return;
      // Use DELETE request like in widget
      const resp = await fetch(`/game-accounts/${it.id}/`, {
        method: 'DELETE',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      if (resp.status === 204) {
        showToast('Account deleted successfully.');
        load();
      } else if (resp.status === 403) {
        showToast('Permission denied', true);
      } else {
        showToast('Delete failed', true);
      }
    });
    right.appendChild(del);
    div.appendChild(left);
    div.appendChild(right);
    return div;
  }

  function getToastPortal(){
    let portal = document.getElementById('tp-toast-portal');
    if (!portal) {
      portal = document.createElement('div');
      portal.id = 'tp-toast-portal';
      portal.style.position = 'fixed';
      portal.style.top = '0';
      portal.style.left = '0';
      portal.style.right = '0';
      portal.style.bottom = '0';
      portal.style.zIndex = '99999999999';
      portal.style.pointerEvents = 'none';
      document.body.appendChild(portal);
    }
    return portal;
  }

  function showToast(msg, isError){
    const portal = getToastPortal();
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.pointerEvents = 'auto';
    t.style.position = 'fixed';
    t.style.top = '2.5rem';
    t.style.right = '1.5rem';
    t.style.padding = '0.5rem 1rem';
    t.style.borderRadius = '0.5rem';
    t.style.color = 'white';
    t.style.backgroundColor = isError ? '#ef4444' : '#16a34a';
    t.style.opacity = '0';
    t.style.transition = 'opacity 120ms ease-in-out';
    t.style.zIndex = '99999999999';
    portal.appendChild(t);
    requestAnimationFrame(()=> t.style.opacity = '1');
    setTimeout(()=> { t.style.opacity = '0'; setTimeout(()=> t.remove(), 140); }, 3000);
  }

  async function load(){
    const gameId = document.getElementById('filter-game').value || null;
    const items = await fetchList(gameId);
    const cont = document.getElementById('ga-list');
    cont.innerHTML = '';
    items.forEach(it => cont.appendChild(renderItem(it)));
  }

  document.getElementById('filter-game').addEventListener('change', load);

  document.getElementById('ga-add').addEventListener('click', async ()=>{
    const res = await fetch('/game-accounts/_form/');
    const html = await res.text();
    document.getElementById('ga-modal-body').innerHTML = html;
    document.getElementById('ga-modal').classList.remove('hidden');

    const form = document.getElementById('ga-form');
    document.getElementById('ga-cancel').addEventListener('click', ()=>{
      document.getElementById('ga-modal').classList.add('hidden');
    });
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = {
        game: form.game.value,
        ingame_name: form.ingame_name.value
      };
      const res = await fetch('/game-accounts/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
        body: JSON.stringify(data)
      });
      if (res.status === 201) {
        showToast('Account added.');
        document.getElementById('ga-modal').classList.add('hidden');
        load();
      } else {
        const j = await res.json();
        showToast('Save failed', true);
        console.error(j);
      }
    });
  });

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  await load();
})();
</script>
{% endblock %}
