{% extends 'base.html' %} {% load static %} {% block content %} {% include 'navbar.html' %}

<!-- Banner -->
<section class="w-full px-4 md:px-10 py-6">
  <div
    class="relative w-full rounded-xl overflow-hidden border border-indigo-400 shadow-sm bg-white"
  >
    <img
      src="{% static 'image/BannerValo.png' %}"
      alt="Banner"
      class="w-full h-56 sm:h-64 md:h-80 lg:h-96 object-cover"
    />
    <div
      class="absolute inset-0 flex flex-col justify-center items-start px-6 md:px-12 text-white bg-black/30"
    >
      <h1 class="text-2xl md:text-4xl lg:text-5xl font-extrabold leading-tight">
        TurnaPlay 2025
      </h1>
      <p class="mt-2 text-sm md:text-lg max-w-lg">
        Buktikan timmu jadi juara arena e-sport paling bergengsi!
      </p>
      <a
        href="#"
        class="mt-4 inline-block bg-white text-indigo-600 font-semibold px-5 py-2 rounded-full hover:bg-indigo-50 transition"
        >Daftar Sekarang</a
      >
    </div>
  </div>
</section>

<!-- Game Logos strip -->
<section class="bg-indigo-700/90 py-6 mt-8">
  <div
    class="max-w-7xl mx-auto px-4 flex justify-center items-center flex-wrap gap-6 md:gap-10"
  >
    <img
      src="{% static 'image/ValoLogo.svg' %}"
      alt="Valorant"
      class="h-10 md:h-12"
    />
    <img
      src="{% static 'image/MobileLegendLogo.svg' %}"
      alt="Mobile Legends"
      class="h-10 md:h-12"
    />
    <img
      src="{% static 'image/FCMobile.svg' %}"
      alt="FC Mobile"
      class="h-10 md:h-12"
    />
    <img
      src="{% static 'image/FifaLogo.svg' %}"
      alt="FIFA"
      class="h-10 md:h-12"
    />
    <img
      src="{% static 'image/TekkenLogo.svg' %}"
      alt="Tekken 8"
      class="h-10 md:h-12"
    />
    <img
      src="{% static 'image/DotaLogo.svg' %}"
      alt="Dota 2"
      class="h-10 md:h-12"
    />
    <img
      src="{% static 'image/CODLogo.svg' %}"
      alt="Call of Duty Mobile"
      class="h-10 md:h-12"
    />
  </div>
</section>

<!-- Active Tournament List -->
<main class="max-w-7xl mx-auto px-4 py-8">
  <h2 class="text-2xl font-bold mb-6">Active Tournament List</h2>

  <div
    id="tournament-grid"
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
  >
    {% for tournament in tournaments %} {% include 'card_tournament.html' %} {% endfor %}
  </div>

  <div class="flex items-center justify-between mt-6">
    <div>
      {% if page_obj.has_previous %}
      <a
        id="prev-button"
        data-prev-page="{{ page_obj.previous_page_number }}"
        href="?page={{ page_obj.previous_page_number }}"
        class="inline-block bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-md hover:bg-gray-300 transition"
      >
        &lt; Back
      </a>
      {% endif %}
    </div>

    <div>
      {% if can_create %}
      <a
        href="/tournaments/create/"
        class="bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-indigo-700 transition"
      >
        Create Tournament
      </a>
      {% endif %}
    </div>

    <div>
      {% if page_obj.has_next %}
      <button
        id="next-button"
        data-next-page="{{ page_obj.next_page_number }}"
        class="bg-amber-400 text-gray-900 font-semibold px-4 py-2 rounded-md hover:bg-amber-300 transition"
      >
        Next &gt;
      </button>
      {% endif %}
    </div>
  </div>
</main>

<!-- Template used by JS to append cards (Tailwind classes applied) -->
<template id="tournament-card-template">
  <article
    class="bg-slate-800 rounded-lg overflow-hidden shadow-md transform hover:-translate-y-1 transition"
  >
    <img class="w-full h-44 object-cover" src="" alt="Tournament Banner" />
    <div class="p-4">
      <h3 data-js="name" class="text-lg font-semibold text-white">
        Tournament Name
      </h3>
      <p data-js="date" class="text-sm text-rose-400 font-bold mt-2">
        Tournament Date
      </p>
      <a
        data-js="detail-url"
        href="#"
        class="inline-block mt-4 text-sm bg-transparent border border-slate-400 text-slate-200 px-3 py-1.5 rounded-full font-semibold hover:bg-slate-200 hover:text-slate-900 transition"
        >Detail</a
      >
    </div>
  </article>
</template>

<script>
  // small helper moved to top-level scope to satisfy static analysis
  function safeText(value) {
    return value == null ? "" : String(value);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const tournamentGrid = document.getElementById("tournament-grid");
    const cardTemplate = document.getElementById("tournament-card-template");
    const prevButton = document.getElementById("prev-button");
    const nextButton = document.getElementById("next-button");

    // default banner available server-side
    const defaultBanner = "{% static 'image/BannerValo.png' %}";

    function createTournamentCard(tournament) {
      const cardClone = document.importNode(cardTemplate.content, true);
      const img = cardClone.querySelector("img");

      img.src = tournament.banner || tournament.banner_url || defaultBanner;
      img.alt = `${
        tournament.name || tournament.tournament_name || "Tournament"
      } Banner`;

      const nameEl = cardClone.querySelector('[data-js="name"]');
      const dateEl = cardClone.querySelector('[data-js="date"]');
      const detailEl = cardClone.querySelector('[data-js="detail-url"]');

      nameEl.textContent = safeText(
        tournament.name || tournament.tournament_name
      );
      dateEl.textContent = safeText(
        tournament.date || tournament.tournament_date
      );

      if (tournament.detail_url) {
        detailEl.href = tournament.detail_url;
      } else if (tournament.id) {
        detailEl.href = `/tournaments/${tournament.id}/`;
      } else {
        detailEl.href = "#";
      }

      return cardClone;
    }

    // Render the tournament grid from API data (replaces existing items)
    function renderTournamentsFromData(data) {
      // clear existing
      tournamentGrid.innerHTML = "";
      for (const t of data.tournaments || []) {
        tournamentGrid.appendChild(createTournamentCard(t));
      }

      // Update next/prev button dataset values and visibility
      if (prevButton) {
        if (data.previous_page) {
          prevButton.dataset.prevPage = String(data.previous_page);
          prevButton.href = `?page=${data.previous_page}`;
          prevButton.classList.remove("hidden");
        } else {
          prevButton.classList.add("hidden");
        }
      }

      if (nextButton) {
        if (data.has_next) {
          const np =
            data.next_page !== undefined && data.next_page !== null
              ? data.next_page
              : Number(data.page) + 1;
          nextButton.dataset.nextPage = String(np);
          nextButton.classList.remove("hidden");
          nextButton.disabled = false;
          nextButton.textContent = "Next >";
        } else {
          nextButton.classList.add("hidden");
        }
      }
    }

    async function fetchAndRenderPage(pageNumber) {
      if (!pageNumber) return;
      // update UI
      if (nextButton) {
        nextButton.disabled = true;
        nextButton.textContent = "Loading...";
      }

      try {
        const url = `/api/tournaments/?page=${encodeURIComponent(pageNumber)}`;
        const response = await fetch(url, {
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        renderTournamentsFromData(data);

        // update history (so back button works and direct links possible)
        const newUrl = new URL(globalThis.location.href);
        newUrl.searchParams.set("page", String(data.page || pageNumber));
        globalThis.history.pushState(
          { page: data.page || pageNumber },
          "",
          newUrl.toString()
        );
      } catch (err) {
        console.error("Failed to fetch tournament page:", err);
      } finally {
        if (nextButton) {
          nextButton.disabled = false;
        }
      }
    }

    // Wire Prev and Next to use AJAX navigation if present
    if (prevButton) {
      prevButton.addEventListener("click", (ev) => {
        ev.preventDefault();
        const p =
          prevButton.dataset.prevPage || prevButton.href?.split("page=")?.[1];
        if (p) fetchAndRenderPage(p);
      });
    }

    if (nextButton) {
      nextButton.addEventListener("click", (ev) => {
        ev.preventDefault();
        const p = nextButton.dataset.nextPage;
        if (p) fetchAndRenderPage(p);
      });
    }

    // Handle back/forward browser navigation
    globalThis.addEventListener("popstate", (ev) => {
      const page =
        (ev.state && ev.state.page) ||
        new URL(globalThis.location.href).searchParams.get("page") ||
        1;
      fetchAndRenderPage(page);
    });
  });
</script>

{% include 'footer.html' %} {% endblock %}
