{% extends 'minimal.html' %}
{% load static %}
{% block meta %}
<title>Manage Tournaments - TurnaPlay Admin</title>
{% endblock %}

{% block content %}
<div class="flex min-h-screen grid grid-flow-row bg-gray-50">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        {% include 'admin/_sidebar.html' %}

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="max-w-7xl mx-auto p-6">
                <!-- Messages -->
                {% if messages %}
                <div class="fixed top-5 right-5 z-50 space-y-2 max-w-md">
                    {% for message in messages %}
                    <div class="{% if message.tags == 'error' %}bg-red-500{% else %}bg-green-500{% endif %} text-white px-4 py-3 rounded-lg shadow-lg animate-slide-in text-sm">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">Manage Tournaments</h1>
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="bg-[#494598] text-white px-4 py-2 rounded-xl flex items-center gap-2 font-medium text-sm hover:bg-[#3d3770] transition">
                            {% if admin.profile_image == 'avatar2' %}
                                <img class="w-8 h-8 rounded-full border-4 border-white/30 shadow-lg" alt="{{ user.display_name }}" src="{% static 'images/profile_images/hero-estes.png' %}">
                            {% elif admin.profile_image == 'avatar3' %}
                                <img class="w-8 h-8 rounded-full border-4 border-white/30 shadow-lg" alt="{{ user.display_name }}" src="{% static 'images/profile_images/hero-akai.png' %}">
                            {% else %}
                                <!-- Default: avatar1 -->
                                <img class="w-8 h-8 rounded-full border-4 border-white/30 shadow-lg" alt="{{ user.display_name }}" src="{% static 'images/profile_images/hero-hayabusa.png' %}">
                            {% endif %}
                            {{ user.display_name }}
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': open }" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div x-show="open" @click.away="open = false" 
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 transform scale-95"
                            x-transition:enter-end="opacity-100 transform scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 transform scale-100"
                            x-transition:leave-end="opacity-0 transform scale-95"
                            class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border border-gray-200 py-1 z-50">
                            
                            <a href="{% url 'tournaments:show_main' %}" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                                </svg>
                                Homepage
                            </a>
                            
                            <div class="border-t border-gray-200 my-1"></div>
                            
                            <form method="post" action="{% url 'user_account:logout' %}">
                                {% csrf_token %}
                                <button type="submit" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                    </svg>
                                    Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-white border border-gray-200 p-5 rounded-xl">
                        <div class="text-gray-500 text-xs mb-1.5">Total Tournament</div>
                        <div class="text-gray-900 text-2xl font-bold">{{ total_tournaments }} <span class="text-sm font-normal text-gray-600">Tournament</span></div>
                    </div>
                    <div class="bg-white border border-gray-200 p-5 rounded-xl">
                        <div class="text-gray-500 text-xs mb-1.5">Tournament Aktif</div>
                        <div class="text-gray-900 text-2xl font-bold">{{ active_tournaments }} <span class="text-sm font-normal text-gray-600">Tournament</span></div>
                    </div>
                    <div class="bg-white border border-gray-200 p-5 rounded-xl">
                        <div class="text-gray-500 text-xs mb-1.5">Pengguna Terdaftar</div>
                        <div class="text-gray-900 text-2xl font-bold">{{ total_participants }} <span class="text-sm font-normal text-gray-600">Pengguna</span></div>
                    </div>
                </div>

                <!-- Tournaments Section -->
                <div class="bg-white border border-gray-200 rounded-xl p-5">
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-lg font-semibold text-gray-900">Daftar Tournament</h2>
                    </div>

                    <!-- Filters -->
                    <form method="get" id="filter-form" class="grid grid-cols-3 gap-3 mb-5">
                        <input type="text" name="search" placeholder="Search tournament name..." 
                            value="{{ search }}" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-[#494598] focus:ring-2 focus:ring-[#494598]/20">
                        
                        <select name="status" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-[#494598] focus:ring-2 focus:ring-[#494598]/20">
                            <option value="">All Tournaments</option>
                            <option value="upcoming" {% if status_filter == 'upcoming' %}selected{% endif %}>Upcoming</option>
                            <option value="past" {% if status_filter == 'past' %}selected{% endif %}>Past</option>
                            <option value="tba" {% if status_filter == 'tba' %}selected{% endif %}>Date TBA</option>
                        </select>
                        
                        <button type="submit" class="bg-[#494598] text-white px-4 py-2 rounded-lg font-medium transition hover:bg-[#3d3770] text-sm">Filter</button>
                    </form>

                    <!-- Tournament List -->
                    <div id="tournament-list" class="space-y-2.5">
                        {% if tournaments %}
                            {% for tournament in tournaments %}
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-[#494598] hover:shadow-sm transition">
                                <div class="grid grid-cols-[1fr_auto_auto_auto_auto] gap-5 items-center">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-0.5">Tournament Name</div>
                                        <div class="font-semibold text-gray-900 text-sm">{{ tournament.tournament_name }}</div>
                                        <div class="text-xs text-gray-500 mt-0.5">{{ tournament.tournament_format.game.name }}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-gray-500 mb-0.5">Organizer</div>
                                        <div class="text-gray-900 text-sm">@{{ tournament.organizer.username }}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-gray-500 mb-0.5">Date</div>
                                        <span class="text-gray-900 text-sm font-medium">
                                            {% if tournament.tournament_date %}
                                                {{ tournament.tournament_date|date:"d M Y" }}
                                            {% else %}
                                                TBA
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-0.5">Participants</div>
                                        <div class="font-medium text-gray-900 text-sm">{{ tournament.participants_count }}/{{ tournament.team_maximum_count }}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <a href="{% url 'user_account:admin_tournament_detail' tournament.id %}" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-xs font-medium hover:bg-gray-200 transition">
                                            Detail
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center py-12 text-gray-500">
                            <img src="{% static 'image/TrophyNavbarLogo.svg' %}" alt="" class="w-12 h-12 mx-auto mb-3">
                            <p class="text-sm">No tournaments found</p>
                            <p class="text-xs mt-1">Tournaments will appear here once created by organizers</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Pagination -->
                    {% if tournaments.has_other_pages %}
                    <div class="flex justify-center items-center gap-3 mt-5 pt-5 border-t border-gray-200">
                        {% if tournaments.has_previous %}
                        <a href="?page={{ tournaments.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           class="px-4 py-2 rounded-lg text-sm font-medium border text-gray-700 border-gray-300 hover:bg-gray-50 transition">
                            ← Previous
                        </a>
                        {% else %}
                        <button disabled class="px-4 py-2 rounded-lg text-sm font-medium border text-gray-400 border-gray-200 cursor-not-allowed">
                            ← Previous
                        </button>
                        {% endif %}
                        
                        <div class="flex items-center gap-2">
                            {% for num in tournaments.paginator.page_range %}
                                {% if num == tournaments.number %}
                                    <span class="px-3 py-2 rounded-lg text-sm font-semibold bg-[#494598] text-white">
                                        {{ num }}
                                    </span>
                                {% elif num > tournaments.number|add:'-3' and num < tournaments.number|add:'3' %}
                                    <a href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                                       class="px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                                        {{ num }}
                                    </a>
                                {% elif num == 1 or num == tournaments.paginator.num_pages %}
                                    <a href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                                       class="px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                                        {{ num }}
                                    </a>
                                    {% if num == 1 and tournaments.number > 4 %}
                                        <span class="text-gray-400">...</span>
                                    {% elif num == tournaments.paginator.num_pages and tournaments.number < tournaments.paginator.num_pages|add:'-3' %}
                                        <span class="text-gray-400">...</span>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        {% if tournaments.has_next %}
                        <a href="?page={{ tournaments.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           class="px-4 py-2 rounded-lg text-sm font-medium border text-gray-700 border-gray-300 hover:bg-gray-50 transition">
                            Next →
                        </a>
                        {% else %}
                        <button disabled class="px-4 py-2 rounded-lg text-sm font-medium border text-gray-400 border-gray-200 cursor-not-allowed">
                            Next →
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <div class="bg-[#302D74] h-[28px] flex justify-center items-center font-semibold text-xs text-white">
        © 2025 TurnaPlay - All rights reserved.
    </div>
</div>

<script  defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js">
// Auto-hide messages
setTimeout(() => {
    const messages = document.querySelectorAll('.animate-slide-in');
    messages.forEach(msg => {
        msg.style.opacity = '0';
        msg.style.transform = 'translateX(100%)';
        msg.style.transition = 'all 0.3s';
        setTimeout(() => msg.remove(), 300);
    });
}, 5000);
</script>

<style>
@keyframes slide-in {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
.animate-slide-in {
    animation: slide-in 0.3s ease;
}
</style>
{% endblock %}
