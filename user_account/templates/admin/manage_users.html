{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>Manage Users - TurnaPlay Admin</title>
{% endblock %}

{% block content %}
<div class="flex min-h-screen grid grid-flow-row bg-gray-50">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="bg-[#494598] p-5 flex flex-col transition-all duration-300 ease-in-out" style="width: 240px;">
            <!-- Header dengan toggle button -->
            <div class="flex items-center justify-between mb-10">
                <div class="text-lg font-bold text-white flex items-center gap-2 sidebar-content">
                    üèÜ <span>TurnaPlay</span>
                </div>
                <button onclick="toggleSidebar()" class="w-full text-white hover:bg-white/10 p-1.5 flex items-center justify-center rounded-lg transition">
                    <svg id="toggle-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                    </svg>
                </button>
            </div>
            
            <nav class="flex-1 space-y-1.5">
                <a href="{% url 'user_account:admin_manage_users' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white text-[#494598] font-medium text-sm">
                    <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    <span class="sidebar-content">Manage Users</span>
                </a>
                <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-white/50 cursor-not-allowed text-sm">
                    <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    <span class="sidebar-content">Manage Tournaments</span>
                </div>
            </nav>
            
            <form method="post" action="{% url 'user_account:logout' %}">
                {% csrf_token %}
                <button type="submit" class="w-full bg-red-600 text-white px-3 py-2.5 rounded-lg font-medium transition-all hover:bg-red-700 text-sm flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <span class="sidebar-content">Log Out</span>
                </button>
            </form>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="max-w-7xl mx-auto p-6">
                <!-- Messages -->
                {% if messages %}
                <div class="fixed top-5 right-5 z-50 space-y-2 max-w-md">
                    {% for message in messages %}
                    <div class="{% if message.tags == 'error' %}bg-red-500{% else %}bg-green-500{% endif %} text-white px-4 py-3 rounded-lg shadow-lg animate-slide-in text-sm">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">Manage Users</h1>
                    <div class="bg-[#494598] text-white px-4 py-2 rounded-xl flex items-center gap-2 font-medium text-sm">
                        <img src="https://ui-avatars.com/api/?name=Admin&background=fff&color=494598&size=32" class="w-6 h-6 rounded-full">
                        Admin
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white border border-gray-200 p-5 rounded-xl">
                        <div class="text-gray-500 text-xs mb-1.5">Total Pengguna</div>
                        <div class="text-gray-900 text-2xl font-bold">{{ total_users }} <span class="text-sm font-normal text-gray-600">Pengguna</span></div>
                    </div>
                    <div class="bg-white border border-gray-200 p-5 rounded-xl">
                        <div class="text-gray-500 text-xs mb-1.5">Pengguna Aktif</div>
                        <div class="text-gray-900 text-2xl font-bold">{{ active_users }} <span class="text-sm font-normal text-gray-600">Pengguna</span></div>
                    </div>
                </div>

                <!-- Users Section -->
                <div class="bg-white border border-gray-200 rounded-xl p-5">
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-lg font-semibold text-gray-900">Pengguna Aktif</h2>
                        <!-- Add a Button that triggers the Modal -->
                        <a href="#" id="createOrganizerBtn" class="bg-[#494598] text-white px-4 py-2 rounded-lg font-medium transition-all hover:bg-[#3d3770] text-sm">
                            + Create Organizer
                        </a>

                        <!-- Modal Structure -->
                        <div id="createOrganizerModal" class="fixed inset-0 z-50 hidden justify-center items-center overflow-hidden">
                            <div class="bg-white bg-opacity-60 rounded-xl w-full h-screen overflow-auto">
                                <!-- Close Button -->
                                <button id="closeModalBtn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                        <path fill-rule="evenodd" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                
                                <!-- Modal Content -->                                
                                <!-- Include the form from create_organizer.html -->
                                {% include 'admin/create_organizer.html' %}
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <form method="get" id="filter-form" class="grid grid-cols-4 gap-3 mb-5">
                        <input type="text" name="search" placeholder="Search username..." 
                            value="{{ search }}" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-[#494598] focus:ring-2 focus:ring-[#494598]/20">
                        
                        <select name="role" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-[#494598] focus:ring-2 focus:ring-[#494598]/20">
                            <option value="">All Roles</option>
                            <option value="user" {% if role_filter == 'user' %}selected{% endif %}>User</option>
                            <option value="organizer" {% if role_filter == 'organizer' %}selected{% endif %}>Organizer</option>
                            <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
                        </select>
                        
                        <select name="status" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-[#494598] focus:ring-2 focus:ring-[#494598]/20">
                            <option value="">All Status</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                        </select>
                        
                        <button type="submit" class="bg-[#494598] text-white px-4 py-2 rounded-lg font-medium transition hover:bg-[#3d3770] text-sm">Filter</button>
                    </form>

                    <!-- User List -->
                    <div id="user-list" class="space-y-2.5">
                        {% for user in users %}
                        <div class="border border-gray-200 rounded-lg p-4 hover:border-[#494598] hover:shadow-sm transition">
                            <div class="grid grid-cols-[1fr_auto_auto_auto_auto] gap-5 items-center">
                                <div>
                                    <div class="text-xs text-gray-500 mb-0.5">Username</div>
                                    <div class="font-semibold text-gray-900 text-sm">@{{ user.username }}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 mb-0.5">Role</div>
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold {% if user.role == 'user' %}bg-blue-100 text-blue-700{% elif user.role == 'organizer' %}bg-orange-100 text-orange-700{% else %}bg-purple-100 text-purple-700{% endif %}">
                                        {{ user.get_role_display }}
                                    </span>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-500 mb-0.5">Status</div>
                                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold inline-flex items-center gap-1.5 {% if user.is_active %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                                        <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
                                        {% if user.is_active %}Aktif{% else %}Inactive{% endif %}
                                    </span>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-0.5">Tanggal</div>
                                    <div class="font-medium text-gray-900 text-sm">{{ user.date_joined|date:"d M Y" }}</div>
                                </div>
                                <div class="flex gap-2">
                                    <a href="{% url 'user_account:admin_user_detail' user.id %}" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-xs font-medium hover:bg-gray-200 transition">
                                        Detail
                                    </a>
                                    <button onclick="toggleUserStatus('{{ user.id }}', {{ user.is_active|lower }})" 
                                            class="px-3 py-1.5 rounded-lg text-xs font-medium transition {% if user.is_active %}bg-red-50 text-red-700 hover:bg-red-100{% else %}bg-green-50 text-green-700 hover:bg-green-100{% endif %}">
                                        {% if user.is_active %}Nonaktifkan{% else %}Activate{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center py-8 text-gray-500 text-sm">No users found</p>
                        {% endfor %}
                    </div>

                    <!-- Pagination with AJAX -->
                    {% if users.has_other_pages %}
                    <div class="flex justify-center items-center gap-3 mt-5 pt-5 border-t border-gray-200">
                        <button onclick="loadPage({{ users.previous_page_number }})" 
                                {% if not users.has_previous %}disabled{% endif %}
                                class="px-4 py-2 rounded-lg text-sm font-medium border transition {% if users.has_previous %}text-gray-700 border-gray-300 hover:bg-gray-50{% else %}text-gray-400 border-gray-200 cursor-not-allowed{% endif %}">
                            ‚Üê Previous
                        </button>
                        
                        <div class="flex items-center gap-2">
                            {% for num in users.paginator.page_range %}
                                {% if num == users.number %}
                                    <button class="px-3 py-2 rounded-lg text-sm font-semibold bg-[#494598] text-white">
                                        {{ num }}
                                    </button>
                                {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
                                    <button onclick="loadPage({{ num }})" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                                        {{ num }}
                                    </button>
                                {% elif num == 1 or num == users.paginator.num_pages %}
                                    <button onclick="loadPage({{ num }})" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition">
                                        {{ num }}
                                    </button>
                                    {% if num == 1 and users.number > 4 %}
                                        <span class="text-gray-400">...</span>
                                    {% elif num == users.paginator.num_pages and users.number < users.paginator.num_pages|add:'-3' %}
                                        <span class="text-gray-400">...</span>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        <button onclick="loadPage({{ users.next_page_number }})" 
                                {% if not users.has_next %}disabled{% endif %}
                                class="px-4 py-2 rounded-lg text-sm font-medium border transition {% if users.has_next %}text-gray-700 border-gray-300 hover:bg-gray-50{% else %}text-gray-400 border-gray-200 cursor-not-allowed{% endif %}">
                            Next ‚Üí
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <div class="bg-[#302D74] h-[28px] flex justify-center items-center font-semibold text-xs text-white">
        ¬© 2025 TurnaPlay - All rights reserved.
    </div>
</div>

<script>
// Sidebar Toggle Function
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const icon = document.getElementById('toggle-icon');
    const sidebarContent = document.querySelectorAll('.sidebar-content');
    
    // Check the current sidebar width and toggle accordingly
    if (sidebar.style.width === '240px') {
        sidebar.style.width = '80px';
        sidebarContent.forEach(el => el.style.display = 'none');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>';
        localStorage.setItem('sidebarState', 'closed'); // Save state to localStorage
    } else {
        sidebar.style.width = '240px';
        setTimeout(() => {
            sidebarContent.forEach(el => el.style.display = '');
        }, 200);
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>';
        localStorage.setItem('sidebarState', 'open'); // Save state to localStorage
    }
}

// Ensure the sidebar state is remembered when navigating to the User Detail page
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const savedState = localStorage.getItem('sidebarState');
    
    if (savedState === 'closed') {
        sidebar.style.width = '80px';
        const sidebarContent = document.querySelectorAll('.sidebar-content');
        sidebarContent.forEach(el => el.style.display = 'none');
        document.getElementById('toggle-icon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>';
    }
});

// AJAX Pagination
function loadPage(pageNum) {
    if (!pageNum) return;
    
    const form = document.getElementById('filter-form');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    params.set('page', pageNum);
    
    // Show loading
    const userList = document.getElementById('user-list');
    userList.style.opacity = '0.5';
    userList.style.pointerEvents = 'none';
    
    fetch(`?${params.toString()}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Parse the HTML and extract just the user list
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newUserList = doc.getElementById('user-list');
        const newPagination = doc.querySelector('.flex.justify-center.items-center.gap-3.mt-5');
        
        if (newUserList) {
            userList.innerHTML = newUserList.innerHTML;
        }
        
        // Update pagination
        const paginationContainer = document.querySelector('.flex.justify-center.items-center.gap-3.mt-5');
        if (paginationContainer && newPagination) {
            paginationContainer.innerHTML = newPagination.innerHTML;
        }
        
        // Update URL without reload
        window.history.pushState({}, '', `?${params.toString()}`);
        
        // Restore
        userList.style.opacity = '1';
        userList.style.pointerEvents = 'auto';
        
        // Scroll to top of user list
        userList.scrollIntoView({ behavior: 'smooth', block: 'start' });
    })
    .catch(error => {
        console.error('Error:', error);
        userList.style.opacity = '1';
        userList.style.pointerEvents = 'auto';
    });
}

// Toggle User Status
function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'deactivate' : 'activate';
    if (!confirm(`Are you sure you want to ${action} this user?`)) {
        return;
    }

    fetch(`/user/admin/users/${userId}/deactivate/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'An error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

// Auto-hide messages
setTimeout(() => {
    const messages = document.querySelectorAll('.animate-slide-in');
    messages.forEach(msg => {
        msg.style.opacity = '0';
        msg.style.transform = 'translateX(100%)';
        msg.style.transition = 'all 0.3s';
        setTimeout(() => msg.remove(), 300);
    });
}, 5000);

const createOrganizerBtn = document.getElementById('createOrganizerBtn');
const modal = document.getElementById('createOrganizerModal');
const closeModalBtn = document.getElementById('closeModalBtn');

// Show the modal when the button is clicked
createOrganizerBtn.addEventListener('click', function(event) {
    event.preventDefault(); // Prevent redirect
    modal.classList.remove('hidden');
});

// Hide the modal when the close button is clicked
closeModalBtn.addEventListener('click', function() {
    modal.classList.add('hidden');
});
</script>

<style>
@keyframes slide-in {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
.animate-slide-in {
    animation: slide-in 0.3s ease;
}

/* Smooth transitions for sidebar */
#sidebar {
    transition: width 0.3s ease-in-out;
}

.sidebar-content {
    transition: opacity 0.2s ease-in-out;
}
</style>
{% endblock %}