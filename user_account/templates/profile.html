{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Profile - TurnaPlay</title>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex flex-col font-montserrat">
    <!-- Navbar -->
    {% include 'navbar.html' %}

    <!-- Content -->
    <div class="flex-1 max-w-5xl w-full mx-auto px-5 py-8">
        <!-- Profile Header -->
        <div class="bg-[#494598] text-white p-10 rounded-3xl flex justify-between items-center mb-6 shadow-lg relative overflow-hidden">
            <!-- Background Pattern -->
            <div class="absolute inset-0 opacity-10">
                <div class="absolute top-0 right-0 w-64 h-64 bg-white rounded-full -translate-y-1/2 translate-x-1/2"></div>
                <div class="absolute bottom-0 left-0 w-48 h-48 bg-white rounded-full translate-y-1/2 -translate-x-1/2"></div>
            </div>
            
            <div class="flex w-full items-center gap-10 relative z-10">
                {% if user.profile_image == 'avatar2' %}
                    <img class="w-24 h-24 rounded-full border-4 border-white/30 shadow-lg" alt="{{ user.display_name }}" src="{% static 'images/profile_images/hero-estes.png' %}">
                {% elif user.profile_image == 'avatar3' %}
                    <img class="w-24 h-24 rounded-full border-4 border-white/30 shadow-lg" alt="{{ user.display_name }}" src="{% static 'images/profile_images/hero-akai.png' %}">
                {% else %}
                    <!-- Default: avatar1 -->
                    <img class="w-24 h-24 rounded-full border-4 border-white/30 shadow-lg" alt="{{ user.display_name }}" src="{% static 'images/profile_images/hero-hayabusa.png' %}">
                {% endif %}
                <div>
                    <h1 class="text-3xl mb-1">{{ user.display_name }}</h1>
                    <div class="flex gap-4 text-sm">
                        <span>{{ user.email }}</span>
                    </div>
                </div>
                <div class="text-base opacity-90 ml-10 mb-3">
                    Username
                    <br>
                    <span>{{ user.username }}</span>
                </div>
            </div>
            <a href="{% url 'user_account:update_profile' %}" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold transition flex items-center gap-2 relative z-10">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                </svg>
                Edit
            </a>
        </div>

        <!-- Tournament History -->
        <h2 class="text-xl font-semibold text-gray-900 mb-5">History Tournament</h2>
        <div class="bg-white rounded-2xl p-6 mb-6 shadow-sm border border-gray-300">
            
            {% if tournaments %}
            <div class="space-y-3">
                {% for tournament in tournaments %}
                <div class="border border-gray-200 rounded-xl p-5 hover:border-[#494598] hover:shadow-md transition">
                    <div class="grid grid-cols-4 gap-4 items-center">
                        <div class="font-semibold text-gray-900">
                            Nama Turnamen
                            <br>
                            <span class="text-base font-semibold text-gray-900">{{ tournament.name }}</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            Game
                            <br>
                            <span class="text-base font-semibold text-gray-900">
                                {{ tournament.game }}
                            </span>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-600">Status</div>
                            <span class="text-xs font-bold inline-flex items-start gap-1.5 {% if tournament.status == 'ongoing' %} text-green-700{% else %}text-red-700{% endif %}">
                                ‚óè {{ tournament.status|title }}
                            </span>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-600">Tanggal</div>
                            <div class="font-medium">{{ tournament.date }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-500">
                <div class="text-5xl mb-3 opacity-50">üèÜ</div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Belum Ada Tournament</h3>
                <p class="text-sm">Anda belum mengikuti tournament apapun.</p>
            </div>
            {% endif %}
        </div>

        <!-- My Game Accounts -->
        <div class="bg-white rounded-2xl p-6 mb-20 shadow-sm border border-gray-300">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                    <span>üéÆ</span> My Game Accounts
                </h2>
                <button id="ga-open" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-xl text-sm font-semibold transition">
                    ‚Üí
                </button>
            </div>
            <!-- include floating widget and make the button open it -->
            {% include 'game_account/select_widget.html' %}
            <script>
                (function(){
                    const btn = document.getElementById('ga-open');
                    if (!btn) return;
                    btn.style.cursor = 'pointer';
                    btn.addEventListener('click', function(){
                        try {
                            console.debug('GA open clicked ‚Äî showGameAccountWidget type:', typeof showGameAccountWidget);
                        } catch (e) {
                            console.debug('GA open clicked ‚Äî showGameAccountWidget not defined yet');
                        }
                        // if widget JS loaded, show it. otherwise to manage page
                        if (typeof showGameAccountWidget === 'function') {
                            showGameAccountWidget();
                        } else {
                            // give developer a helpful hint in console and then fallback (debug pls work)
                            console.warn('Game account widget not available on this page; redirecting to manage page.');
                            window.location.href = "{% url 'game_account:gameaccount-manage' %}";
                        }
                    });
                })();
            </script>
                    <script>
                        // Listen for selection from the floating widget and show details in a modal instead of navigating away
                        (function(){
                            async function openGameAccountDetail(id){
                                try {
                                    const resp = await fetch('/game-accounts/' + id + '/');
                                    if (!resp.ok) {
                                        console.error('Failed to fetch game account detail', resp.status);
                                        return;
                                    }
                                    const data = await resp.json();
                                    // create modal
                                    let modal = document.getElementById('ga-detail-modal');
                                    if (!modal) {
                                        modal = document.createElement('div');
                                        modal.id = 'ga-detail-modal';
                                        modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                                        modal.innerHTML = '<div id="ga-detail-modal-body" class="bg-white rounded p-6 w-96 max-w-full"></div>';
                                        document.body.appendChild(modal);
                                    }
                                    const body = document.getElementById('ga-detail-modal-body');
                                    // helper: cookie util
                                    function getCookie(name) {
                                        const value = `; ${document.cookie}`;
                                        const parts = value.split(`; ${name}=`);
                                        if (parts.length === 2) return parts.pop().split(';').shift();
                                    }
                                    // toast portal helpers to avoid stacking context issues
                                    function getToastPortal(){
                                        let portal = document.getElementById('tp-toast-portal');
                                        if (!portal) {
                                            portal = document.createElement('div');
                                            portal.id = 'tp-toast-portal';
                                            portal.style.position = 'fixed';
                                            portal.style.inset = '0';
                                            portal.style.zIndex = '2147483647';
                                            portal.style.pointerEvents = 'none';
                                            document.body.appendChild(portal);
                                        }
                                        return portal;
                                    }
                                    function showToast(msg, isError){
                                        const portal = getToastPortal();
                                        const t = document.createElement('div');
                                        t.textContent = msg;
                                        t.style.pointerEvents = 'auto';
                                        t.style.position = 'fixed';
                                        // place toast at top-center so it never overlaps the footer
                                        t.style.top = '1.5rem';
                                        // ensure bottom is not set
                                        t.style.bottom = '';
                                        t.style.left = '50%';
                                        t.style.transform = 'translateX(-50%)';
                                        t.style.padding = '0.5rem 1rem';
                                        t.style.borderRadius = '0.5rem';
                                        t.style.color = 'white';
                                        t.style.backgroundColor = isError ? '#ef4444' : '#16a34a';
                                        t.style.opacity = '0';
                                        t.style.transition = 'opacity 120ms ease-in-out';
                                            // ensure toast itself has a very high z-index as extra guarantee
                                            t.style.zIndex = '99999999999';
                                        portal.appendChild(t);
                                        requestAnimationFrame(()=> t.style.opacity = '1');
                                        setTimeout(()=> { t.style.opacity = '0'; setTimeout(()=> t.remove(), 140); }, 3000);
                                    }

                                    body.innerHTML = `
                                            <div class="flex justify-between items-start mb-4">
                                                <h3 class="text-xl font-semibold">${data.ingame_name}</h3>
                                                <button id="ga-detail-close" class="px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded">‚úï</button>
                                            </div>
                                            <div class="mb-2"><strong>Game:</strong> ${data.game_name || data.game}</div>
                                            <div class="mb-2"><strong>User ID:</strong> ${data.user}</div>
                                            <div class="mb-4"><strong>Active:</strong> ${data.active}</div>
                                            <div class="flex justify-end gap-2">
                                                <a href="/game-accounts/html/${id}/" class="px-3 py-2 bg-gray-200 rounded">Open page</a>
                                                <button id="ga-detail-delete" class="px-3 py-2 bg-red-600 text-white rounded">Delete</button>
                                                <button id="ga-detail-close-2" class="px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-xl">Close</button>
                                            </div>
                                    `;
                                    // wire close
                                    document.getElementById('ga-detail-close').addEventListener('click', ()=> modal.remove());
                                    document.getElementById('ga-detail-close-2').addEventListener('click', ()=> modal.remove());
                                    // wire delete
                                    const delBtn = document.getElementById('ga-detail-delete');
                                    if (delBtn) {
                                        delBtn.addEventListener('click', async () => {
                                            if (!confirm('Delete this game account?')) return;
                                            try {
                                                const r = await fetch('/game-accounts/' + id + '/', {
                                                    method: 'DELETE',
                                                    credentials: 'same-origin',
                                                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                                                });
                                                if (r.status === 204) {
                                                    showToast('Account deleted.');
                                                    modal.remove();
                                                    // refresh widget if available
                                                    if (typeof showGameAccountWidget === 'function') showGameAccountWidget();
                                                } else if (r.status === 403) {
                                                    showToast('Not allowed', true);
                                                } else {
                                                    showToast('Delete failed', true);
                                                }
                                            } catch (err) {
                                                console.error('Delete failed', err);
                                                showToast('Delete failed', true);
                                            }
                                        });
                                    }
                                } catch (err) {
                                    console.error('Error opening game account detail', err);
                                }
                            }

                            window.addEventListener('gameaccount:selected', function(e){
                                try {
                                    const id = e && e.detail && e.detail.id;
                                    if (!id) return;
                                    openGameAccountDetail(id);
                                } catch (err) {
                                    console.error('Error handling gameaccount:selected', err);
                                }
                            });
                        })();
                    </script>
        </div>

        <!-- Logout Button -->
        <form method="post" action="{% url 'user_account:logout' %}" class="flex justify-end mt-20">
            {% csrf_token %}
            <button type="submit" class="mt-20 bg-red-600 text-white px-8 py-3 rounded-xl font-semibold transition-all hover:bg-red-700 hover:shadow-lg">
                Log Out
            </button>
        </form>
    </div>

    <!-- Footer -->
    {% include 'footer.html' %}
</div>
{% endblock %}