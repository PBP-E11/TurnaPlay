{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}
{% include 'team/header.html' %}

<main class="mx-10 my-10 flex flex-col items-center">
  <form method="POST" class="w-full max-w-4xl">
    {% csrf_token %}
    <h2 class="text-indigo-800 text-xl mb-10 font-semibold text-center">Daftar Kompetisi</h2>

    <div class="mb-8 xl:flex gap-8">
      <section class="mb-8 flex-1">
        <h3 class="mb-2 font-medium">Nama Tim</h3>
        <div class="flex border border-gray-500 rounded-lg p-4 gap-2">
          {# Many people icon #}
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#8b8b8b" d="M12 10a4 4 0 1 0 0-8a4 4 0 0 0 0 8m-6.5 3a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5M21 10.5a2.5 2.5 0 1 1-5 0a2.5 2.5 0 0 1 5 0m-9 .5a5 5 0 0 1 5 5v6H7v-6a5 5 0 0 1 5-5m-7 5c0-.693.1-1.362.288-1.994l-.17.014A3.5 3.5 0 0 0 2 17.5V22h3zm17 6v-4.5a3.5 3.5 0 0 0-3.288-3.494c.187.632.288 1.301.288 1.994v6z"/></svg>
          <p class="flex-grow">{{ team_form.team_name }}</p>
          {% if is_leader %}
          {# Edit icon #}
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="#8b8b8b" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path d="M19.09 14.441v4.44a2.37 2.37 0 0 1-2.369 2.369H5.12a2.37 2.37 0 0 1-2.369-2.383V7.279a2.356 2.356 0 0 1 2.37-2.37H9.56"/><path d="M6.835 15.803v-2.165c.002-.357.144-.7.395-.953l9.532-9.532a1.36 1.36 0 0 1 1.934 0l2.151 2.151a1.36 1.36 0 0 1 0 1.934l-9.532 9.532a1.36 1.36 0 0 1-.953.395H8.197a1.36 1.36 0 0 1-1.362-1.362M19.09 8.995l-4.085-4.086"/></g></svg>
          {% endif %}
        </div>
      </section>

      <section class="mb-8 flex-1">
        <h3 class="mb-2 font-medium">Leader</h3>
        <div class="flex border border-gray-500 rounded-lg p-4 gap-2">
          {# Single person icon #}
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512"><path fill="#8b8b8b" d="M332.64 64.58C313.18 43.57 286 32 256 32c-30.16 0-57.43 11.5-76.8 32.38c-19.58 21.11-29.12 49.8-26.88 80.78C156.76 206.28 203.27 256 256 256s99.16-49.71 103.67-110.82c2.27-30.7-7.33-59.33-27.03-80.6M432 480H80a31 31 0 0 1-24.2-11.13c-6.5-7.77-9.12-18.38-7.18-29.11C57.06 392.94 83.4 353.61 124.8 326c36.78-24.51 83.37-38 131.2-38s94.42 13.5 131.2 38c41.4 27.6 67.74 66.93 76.18 113.75c1.94 10.73-.68 21.34-7.18 29.11A31 31 0 0 1 432 480"/></svg>
          <p class="flex-grow">{{ leader_form.instance.game_account.user.username }}</p>
          <p class="flex-grow">{{ leader_form.game_account }}</p>
          {{ leader_form.team }} {# Hidden #}
          {# Edit icon #}
          {% if is_leader %}
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="#8b8b8b" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path d="M19.09 14.441v4.44a2.37 2.37 0 0 1-2.369 2.369H5.12a2.37 2.37 0 0 1-2.369-2.383V7.279a2.356 2.356 0 0 1 2.37-2.37H9.56"/><path d="M6.835 15.803v-2.165c.002-.357.144-.7.395-.953l9.532-9.532a1.36 1.36 0 0 1 1.934 0l2.151 2.151a1.36 1.36 0 0 1 0 1.934l-9.532 9.532a1.36 1.36 0 0 1-.953.395H8.197a1.36 1.36 0 0 1-1.362-1.362M19.09 8.995l-4.085-4.086"/></g></svg>
          {% endif %}
        </div>
      </section>
    </div>

    <!-- Confirmed members list -->
    <section class="mb-8 w-full">
      <h3 class="mb-2 font-medium">Anggota Tim</h3>

      <!-- AJAX-rendered container -->
      <div id="member-list" class="border border-gray-500 rounded-lg divide-y divide-gray-300">
        <p class="text-gray-500 italic p-4">Memuat daftar anggota...</p>
      </div>

      {% if is_leader %}
      <a href="{% url 'tournament_invite:invite-list' %}" class="text-indigo-800 underline">
        Invite member
      </a>
      {% endif %}
    </section>

    {% include 'team/errors.html' %}

    <div class="flex justify-between items-center flex-wrap gap-4">
      <button id="leave-team-btn" type="button" class="w-64 h-16 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-2xl">
        {% if is_leader %}
        Bubarkan Tim
        {% else %}
        Keluar Dari Tim
        {% endif %}
      </button>
      {% if is_leader %}
      <button type="submit" class="w-64 h-16 bg-indigo-800 hover:bg-indigo-900 text-white font-semibold rounded-2xl">
        Perbarui Data Tim
      </button>
      {% endif %}
    </div>
  </form>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const teamId = "{{ team.id }}";
  const memberListEl = document.getElementById("member-list");
  const leaveBtn = document.getElementById("leave-team-btn");

  async function loadMembers() {
    try {
      const response = await fetch(`/team/api/${teamId}/list_members`);
      if (!response.ok) throw new Error("Failed to load members");
      const data = await response.json();

      if (!data.length) {
        memberListEl.innerHTML = `
          <p class="text-gray-500 italic p-4">
            Belum ada anggota lain yang terkonfirmasi.
          </p>`;
        return;
      }

      memberListEl.innerHTML = data.map(member => `
        <div class="p-4 flex justify-between items-center">
          <div>
            <p class="font-semibold">${member.username}</p>
            <p class="text-gray-500 text-sm">${member.ingame_name}</p>
          </div>
          {% if is_leader %}
          ${member.username !== "{{ user.username }}" ? `
          <button
            type="button"
            class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium px-3 py-1 rounded-lg"
            data-member-id="${member.game_account_id}"
          >
            Keluarkan
          </button>` : ""}
          {% endif %}
        </div>
      `).join("");
    } catch (err) {
      console.error(err);
      memberListEl.innerHTML = `<p class="text-red-500 p-4">Gagal memuat daftar anggota.</p>`;
    }
  }

  // Leave team handler
  if (leaveBtn) {
    leaveBtn.addEventListener("click", async () => {
      if (!confirm("Apakah Anda yakin ingin keluar dari tim ini?")) return;

      try {
        const response = await fetch(`/team/api/${teamId}/leave_team`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
          },
        });

        const data = await response.json();
        if (response.ok) {
          alert("Berhasil keluar dari tim.");
          window.location.href = "/";
        } else {
          alert(`Gagal: ${data.detail}`);
        }
      } catch (err) {
        console.error(err);
        alert("Terjadi kesalahan saat memproses permintaan.");
      }
    });
  }

  // Kick member handler (delegated listener)
  memberListEl.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-member-id]");
    if (!btn) return; // not a kick button

    const memberId = btn.dataset.memberId;
    if (!confirm("Apakah Anda yakin ingin mengeluarkan anggota ini dari tim?")) return;

    try {
      const response = await fetch(`/team/api/${teamId}/kick_member`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ member_id: memberId }),
      });

      const data = await response.json();
      if (response.ok) {
        alert("Anggota berhasil dikeluarkan.");
        loadMembers(); // refresh list
      } else {
        alert(`Gagal: ${data.detail}`);
      }
    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan saat mengeluarkan anggota.");
    }
  });

  // initial load + periodic refresh
  loadMembers();
  setInterval(loadMembers, 10000); // refresh every 10 seconds
});
</script>

{% include 'footer.html' %}
{% endblock content %}
